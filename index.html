function addLayer(url, name, style) {
  fetch(url)
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      return r.json();
    })
    .then(data => {
      const layer = L.geoJSON(data, {
        pane: window.geojsonPane || 'overlayPane',
        interactive: true,
        style: style,

        // attach layer name to each feature, then hook selection
        onEachFeature: function (feature, lyr) {
          lyr._layerName = name;
          window.attachSelectableFeature(feature, lyr);
        }
      });

      window.overlayLayers[name] = layer;
      window.layerControl.addOverlay(layer, name);

      // optional legend (won't crash)
      if (typeof window.addLegendItem === "function") {
        window.addLegendItem(name, style);
      }

      console.log("Loaded:", name, "Features:", data.features ? data.features.length : "n/a");
    })
    .catch(err => console.error("Error loading layer:", name, url, err));
}

fetch("Layers.json")
  .then(r => {
    if (!r.ok) throw new Error(`HTTP ${r.status} for Layers.json`);
    return r.json();
  })
  .then(list => {
    list.forEach(item => addLayer("Data/" + item.file, item.name, item.style));
  })
  .catch(err => console.error("Error loading Layers.json", err));
function addLayer(url, name, style) {
  fetch(url)
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      return r.json();
    })
    .then(data => {
      const layer = L.geoJSON(data, {
        pane: window.geojsonPane || 'overlayPane',
        interactive: true,
        style: style,

        // attach layer name to each feature, then hook selection
        onEachFeature: function (feature, lyr) {
          lyr._layerName = name;
          window.attachSelectableFeature(feature, lyr);
        }
      });

      window.overlayLayers[name] = layer;
      window.layerControl.addOverlay(layer, name);

      // optional legend (won't crash)
      if (typeof window.addLegendItem === "function") {
        window.addLegendItem(name, style);
      }

      console.log("Loaded:", name, "Features:", data.features ? data.features.length : "n/a");
    })
    .catch(err => console.error("Error loading layer:", name, url, err));
}

fetch("Layers.json")
  .then(r => {
    if (!r.ok) throw new Error(`HTTP ${r.status} for Layers.json`);
    return r.json();
  })
  .then(list => {
    list.forEach(item => addLayer("Data/" + item.file, item.name, item.style));
  })
  .catch(err => console.error("Error loading Layers.json", err));
